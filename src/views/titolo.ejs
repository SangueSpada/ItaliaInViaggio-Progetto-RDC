<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="../personal_dist/style.css" />
    
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../personal_dist/our.css">
    <!-- JavaScript Bundle with Popper -->
    <script type="text/javascript" src="../utils.js"></script>
    <script type="text/javascript" src="../maps.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
    <script src="//code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://unpkg.com/scrollreveal"></script>
    
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">


    <title>Offerta cercata</title>
    <style>
      .ui-autocomplete-loading {
        background: white url("images/ui-anim_basic_16x16.gif") right center no-repeat;
      }
      </style>
</head>

<body class="bg2">
    <%- include('navbar')%>
    <div style="padding: 23pt;"></div>


        <div class="container cont">
            <div id="carosello" class="carousel" data-bs-ride="carousel" >
                <div class="carousel-indicators">
                    <button type='button' data-bs-target='#carosello' data-bs-slide-to="0" class='active' aria-current='true' aria-label='Slide "0" '></button>
                    <% (borgo.foto).forEach( (item,index) => {%>
                        <%if(index!=0){ %>
                            <button type='button' data-bs-target='#carosello' data-bs-slide-to="<%=index%>" aria-label='Slide "<%=index%>"'></button>
                        <% } %>
                      <% }) %>
                </div>
                
                <div class="carousel-inner" id="primi_carousel">
                    <div class="carousel-item active">
                        <img style="width:100%; height:800px;  margin: auto;" src="<%=borgo.foto[0]%>">
                    </div>
                    <% (borgo.foto).forEach( (item,index) => {%>
                        <%if(index!=0){ %>   
                            <div class="carousel-item">
                            <img style="width:100%; height:800px;  margin: auto;" src="<%=item%>">
                            </div>
                        <% } %> 
                    <% }) %> 
                </div>        
                <button class="carousel-control-prev" type="button" data-bs-target="#carosello" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carosello" data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
            
              </div>
            
           

            <div class="row pt-2">
                <h3 style="color:bisque; font-weight: bold;"><%=borgo.nome%></h3>
                <h4 style="color: antiquewhite; font-style: italic;">
                    <%=borgo.descrizione%> 
                </h4>
            </div>


            <div id="meteo" hidden="true">
              <div style="padding: 15pt;"></div>
              <table class="table table-responsive" style="min-width: 1200px;">
                  <thead>
                      <tr id="date">

                          <th class="h3 col-auto" style="text-align: center;"></th>
                          <th class="h3 col-auto" style="text-align: center;"></th>
                          <th class="h3 col-auto" style="text-align: center;"></th>
                          <th class="h3 col-auto" style="text-align: center;"></th>
                          <th class="h3 col-auto" style="text-align: center;"></th>
                          <th class="h3 col-auto" style="text-align: center;"></th>
                          <th class="h3 col-auto" style="text-align: center;"></th>
                          <th class="h3 col-auto" style="text-align: center;"></th>
                      </tr>
                      
                  </thead>

                  <tbody>

                      <tr id="icone">
                      
                          <td class="col-auto py-3" style="text-align: center;"><img src=""></td>
                          <td class="col-auto py-3" style="text-align: center;"><img src=""></td>
                          <td class="col-auto py-3" style="text-align: center;"><img src=""></td>
                          <td class="col-auto py-3" style="text-align: center;"><img src=""></td>
                          <td class="col-auto py-3" style="text-align: center;"><img src=""></td>
                          <td class="col-auto py-3" style="text-align: center;"><img src=""></td>
                          <td class="col-auto py-3" style="text-align: center;"><img src=""></td>
                          <td class="col-auto py-3" style="text-align: center;"><img src=""></td>
                      
                      </tr>

                      <tr id="descrizioni">
                      <td class="h5 col-auto py-3" style="text-align: center;"></td>
                      <td class="h5 col-auto py-3" style="text-align: center;"></td>
                      <td class="h5 col-auto py-3" style="text-align: center;"></td>
                      <td class="h5 col-auto py-3" style="text-align: center;"></td>
                      <td class="h5 col-auto py-3" style="text-align: center;"></td>
                      <td class="h5 col-auto py-3" style="text-align: center;"></td>
                      <td class="h5 col-auto py-3" style="text-align: center;"></td>
                      <td class="h5 col-auto py-3" style="text-align: center;"></td>
                      
                      
                      </tr>


                  </tbody>
              </table>
            </div>
            <div class="row mt-2 mb-5">
              <div style="padding: 15pt;"></div>

                <div class="col me-2" id="map">
                </div>
                <div class="col-3 table-wrapper-scroll-y my-custom-scrollbar">
                  <table class="table table-responsive">
                      <thead>
                          <tr>
                            <th scope="col">#</th>
                            <th scope="col">foto</th>
                            <th scope="col">Nome Hotel</th>
                            <th scope="col">Recensioni</th>
                          </tr>
                      </thead>
                      <tbody id="hotelList">
                      </tbody>
                  </table>
              </div>
            </div>
            <div class="row mt-5 mb-5">
              <div id="panel" class="row">
              </div>
              <div class="d-block">
                <button class="btn btn-primary" onclick="invia_seg(0)">l' hotel non esiste pi√π? segnalacelo!</button>
                <button class="btn btn-primary" onclick="invia_seg(1)">l' hotel non offre un buon servizio? segnalacelo!</button>
              </div>
            </div>
            <div class="row mt-4">
                    <nav class="shadow container p-3 rounded-3" style="background-color: #e3f2fd;">
                        <form class="row" method="post" id="Tsolutions">
                            <div class="col-lg-6 mb-2">
                                <input type="text" class="active form-control" id="stazionePartenza" name="stazionePartenza" placeholder="Stazione di partenza" required> 
                            </div>
                            <div class="col-lg-6 mb-2" id="controls">
                              <input type="text" class="active form-control" id="stazioneArrivo" name="stazioneArrivo" value="<%=borgo.stazione%>" readonly>     
                            </div>
                            <div class="col-lg-3 mt-2 d-flex justify-content-center">
                                <label class="active me-1 mt-1" for="dateStandard" >Partenza:</label>
                                <input type="date"  class="form-control" id="CheckInDate" onchange="checkin_fun();" name="CheckInDate" value="<%= search[1] || '' %>" required>
                                <select class="form-select-sm" id="oraPartenza" name="oraPartenza">
                                  <option value="0">00:00</option>
                                  <option value="1">01:00</option>
                                  <option value="2">02:00</option>
                                  <option value="3">03:00</option>
                                  <option value="4">04:00</option>
                                  <option value="5">05:00</option>
                                  <option value="6">06:00</option>
                                  <option value="7">07:00</option>
                                  <option value="8">08:00</option>
                                  <option value="9">09:00</option>
                                  <option value="10">10:00</option>
                                  <option value="11">11:00</option>
                                  <option value="12">12:00</option>
                                  <option value="13">13:00</option>
                                  <option value="14">14:00</option>
                                  <option value="15">15:00</option>
                                  <option value="16">16:00</option>
                                  <option value="17">17:00</option>
                                  <option value="18">18:00</option>
                                  <option value="19">19:00</option>
                                  <option value="20">20:00</option>
                                  <option value="21">21:00</option>
                                  <option value="22">22:00</option>
                                  <option value="23">23:00</option>

                                </select>
                            </div>
                            <div class="col-lg-3 mt-2 d-flex justify-content-center">
                                <label class="active me-1 mt-1" for="dateStandard">Ritorno:</label>
                                <input type="date" class="form-control" id="CheckOutDate" onchange="checkout_fun();" name="CheckOutDate" value="<%= search[2] || '' %>" required>
                                <select class="form-select-sm" id="oraRitorno"name="oraRitorno">
                                  <option value="0">00:00</option>
                                  <option value="1">01:00</option>
                                  <option value="2">02:00</option>
                                  <option value="3">03:00</option>
                                  <option value="4">04:00</option>
                                  <option value="5">05:00</option>
                                  <option value="6">06:00</option>
                                  <option value="7">07:00</option>
                                  <option value="8">08:00</option>
                                  <option value="9">09:00</option>
                                  <option value="10">10:00</option>
                                  <option value="11">11:00</option>
                                  <option value="12">12:00</option>
                                  <option value="13">13:00</option>
                                  <option value="14">14:00</option>
                                  <option value="15">15:00</option>
                                  <option value="16">16:00</option>
                                  <option value="17">17:00</option>
                                  <option value="18">18:00</option>
                                  <option value="19">19:00</option>
                                  <option value="20">20:00</option>
                                  <option value="21">21:00</option>
                                  <option value="22">22:00</option>
                                  <option value="23">23:00</option>

                                </select>
                            </div>
                            <div class="col-lg-2 mt-2 d-flex justify-content-center">
                                <label class="active me-2 mt-1">Adulti:</label>
                                <div class="btn-group">
                                    <button type="button" id="lessBtnA" class="btn btn-light rounded-circle" onclick="lessBtnRangeA()">-</button>
                                    <input type="number" value="<%= search[3] || 1 %>" name="adulti" id="adulti" class="form-control-plaintext text-center" readonly style="width: 25pt;">
                                    <button type="button" id="moreBtnA" class="btn btn-light rounded-circle" onclick="moreBtnRangeA()">+</button>
                                </div>
                            </div>
                            <div class="col-lg-2 mt-2 d-flex justify-content-center">
                                <label class="active me-2 mt-1">Ragazzi:</label>
                                <div class="btn-group">
                                    <button type="button" id="lessBtnR" class="btn btn-light rounded-circle" onclick="lessBtnRangeR()">-</button>
                                    <input type="number" value="<%= search[4] || 0 %>" name="ragazzi" id="ragazzi" class="form-control-plaintext text-center" readonly style="width: 25pt;">
                                    <button type="button" id="moreBtnR" class="btn btn-light rounded-circle" onclick="moreBtnRangeR()">+</button>
                                </div>
                            </div>
                            
                            <div class="col-lg-2 mt-2 d-flex justify-content-center">
                                <button class="btn btn-danger rounded-3 fw-bold" onclick="validSearch()">Cerca treni<i class="ms-2 bi bi-search"></i></button>
                            </div>
                        </form>

                    </nav>
                    <div style="padding: 20pt;"></div>


                    <button class="btn btn-primary rounded-3 fw-bold" onclick="valid()">aggiungi viaggio a google calendar</button>


                    <div style="padding: 20pt;"></div>
            </div>
            <div class="row">
              <div id="err_tr" class="h3 text-center" style="color: red;"></div>
              <div class="col-lg-6" id="depSol">
              </div>
              <div class="col-lg-6" id="backSol">
              </div>
              
            </div>
      </div>
        <%- include('footer'); -%>
</body>

<script type="text/javascript">


function invia_seg(nn){



  if ("WebSocket" in window){ 
      
              var ws;
              let prot=window.location.protocol;
              console.log(prot);
              if(prot=='https:'){
              ws=new WebSocket("wss://"+window.location.host+"/ws");
              }
              else{
                ws=new WebSocket("ws://"+window.location.host+"/ws");
              }
            
 
               ws.onopen = function() 
               { 

                let n=document.getElementById('place_id');
                if(n!==null){

                  if(nn){

                    let message= {
                      name:n.textContent,
                      topic:'servizio',
                      borgo:"<%=borgo.nome%>"
                    }
                    console.log(JSON.stringify(message));

                    ws.send(JSON.stringify(message));

                  }
                  else{
                  let message= {
                      name:n.textContent,
                      topic:'esistenza',
                      borgo:"<%=borgo.nome%>"

                    }
                    console.log(JSON.stringify(message));

                  ws.send(JSON.stringify(message));
                  }
                  console.log('mandata');
                
                
                }
               }; 
 
               
               ws.onmessage = function (evt) 
               { 
                  var received_msg = evt.data; 
                  alert("Message is received..."+received_msg); 
                  //document.write("Message is received..."+received_msg); 
               }; 
 
               ws.onclose = function() 
               { 
                  // websocket is closed. 
                  console.log("Connection is closed..."); 
               }; 
 
               window.onbeforeunload = function(event) { 
                  socket.close(); 
               }; 
            } 
 
  else{ 
     // The browser doesn't support WebSocket 
     alert("WebSocket NOT supported by your Browser!"); 
  }

}




var url='<%=url%>';
url=url.replaceAll('&amp;','&');



function valid() {
let a=  $('#CheckInDate')[0].value;
let b= $('#CheckOutDate')[0].value;
let json={};

 if(a!='' && b!=''){
  json["in"]=a;
  json["out"]=b;
  json["nome"]="<%=borgo.nome%>";
  json["descr"]="prenotato viaggio per il borgo <%=borgo.nome%>, un grazie dallo staff di Italia in viaggio!";
  

    let s=JSON.stringify(json);
    let ss='state='+s
    console.log(ss);

    url=url.replace('state={}',ss);

    let newWindow= window.open(url,'name','height=600,width=450');
    if(window.focus){
    newWindow.focus();
    newWindow.onload() = newWindow.close();
    }
    //document.location.href=url;
 }
}

$( function() {
  var httpreq= new XMLHttpRequest(); 
    httpreq.responseType='json'; 
    httpreq.onreadystatechange= function(e){ 
        if(this.readyState==4 && this.status == 200){ 
            let meteos=this.response; 
            $("#meteo")[0].hidden=false; 
           //document.getElementById("meteo").textContent=document.getElementById("meteo").textContent+(meteos[t].weather[0].description+'+++'); 
           $("#date").find("th").each(function(index){ 
               var data=new Date(meteos[index].dt*1000); 
           $(this)[0].textContent=String(new Intl.DateTimeFormat().format(data));}); 
           $("#icone").find("td").each(function(index){ 
            var url_icon='http://openweathermap.org/img/wn/'+meteos[index].weather[0].icon+'@2x.png'; 
            $(this).find("img")[0].src=url_icon; 
           }); 
           $("#descrizioni").find("td").each(function(index){ 
            $(this)[0].textContent=meteos[index].weather[0].description; 
           }); 
        } 
        else if(this.readyState==4 && this.status ==500){ 
            console.log('errore 500 '+this.response); 
         } 
        else if(this.readyState==4 && this.status !=500 & this.status!=200){ 
            console.log(this.response); 
         }    
    } 
//let body='lat='+lat+'&lon='+long;
let body='name=<%=borgo.nome%>';
console.log('<%=borgo.nome%>');
httpreq.open("POST","/owm",true); 
httpreq.setRequestHeader("Content-Type","application/x-www-form-urlencoded"); 
httpreq.send(body); 

});


var db;
$( function() {
      $( "#stazionePartenza" ).autocomplete({
        minLength: 3,
        source: function( request, response ) {        
          $.getJSON( '/stazioni_autocomplete',request, function(data) {
            db=data;
            response( data );
          });
        }
      });
    });

function validSearch(){ 
        var search= document.getElementById("stazionePartenza");
        console.log(db);
        if(!db.includes(search.value)){
            console.log(search.value);
            alert("Attenzione la stazione inserita non √® valida");
            event.stopPropagation();
            event.preventDefault();
        }
    }

  document.getElementById("Tsolutions").onsubmit = function(e) {
  e.preventDefault();
  
  document.getElementById("err_tr").textContent='';

  var formData = new FormData(document.getElementById("Tsolutions")); //salva i dati della form 
  var xhr = new XMLHttpRequest(); 
  xhr.onreadystatechange= function(event){ 
    if(this.readyState==1){
      waitinSolutions();
    }
    else if(this.readyState==4 && this.status == 200){ 

      if(event.target.response.includes('Request failed with status code')){
        let err=document.getElementById("err_tr");
        err.textContent='non esistono soluzioni di viaggio dalla corrente stazione di partenza, riprovi con un\' altra';
        let a=document.getElementById("depSol");
        a.innerHTML='<div class="col-lg-6" id="depSol"></div>';
        let r=document.getElementById("backSol");
        r.innerHTML='<div class="col-lg-6" id="backSol"></ws>';
        return;
      }

      var sol = JSON.parse(event.target.response);
      cardSolutions(sol);
    }
  }; 
  xhr.open("POST","/searchTsolutions",true); 
  xhr.send(formData);
};

  
  




    //effetto scroll rallentato
    $(function() {

        $('a[href*="#"]:not([href="#"])').click(function() {

            if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') && location.hostname == this.hostname) {

                var target = $(this.hash);
                target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
                if (target.length) {

                    $('html,body').animate({

                        scrollTop: target.offset().top
                    }, 500);
                    return false;

                }


            }



        });




    });
    //l'unico modo per passare i borgo 
    var n="<%=borgo.nome%>";
    var r="<%=borgo.regione%>";
    var la="<%=borgo.lat%>";
    var lo="<%=borgo.long%>";
    var zo="<%=borgo.zoom%>";                         
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=<%=maps_key%>&callback=initMap&libraries=places" defer></script>

</html>